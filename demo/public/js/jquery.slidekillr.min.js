(function($) {
    $.fn.SlideKillr=function(options) {

        var defauts= {
            "interval": 3000,
            "transitionSpeed": 1000,
            "transitionEffect": "fade",
            "indicators": true,
            "indicatorsPosition":"outside",
            "indicatorsColor":"#fff",
            "arrows": true,
            "arrowsPosition":"inside",
            "caption": true,
            "captionType":"basic",
	    "captionBackground":"#000",
	    "captionBackgroundOpacity":"0.9",
	    "captionColor":"#fff",
        };  
        var params=$.extend(defauts, options); 

	var countElement = 0;

        function generateIndicator(elt, params) {
            var indicators = $('<ol></ol>').addClass('sk_'+params.indicatorsPosition);
            for (i = 0; i < $(elt).find('.sk_item_container').length; i++) {
		var indicator = $('<li></li>').attr('data-sk-to', i);
                $(indicators).append($(indicator));
		$(indicator).on('click', function(){
                    showElement(elt, params, $(this).data('sk-to'));
                });
            }
            $(elt).append($(indicators));
        }
	
	function generateCaption(elt, params) {
	    if (params.caption) {
		$(elt).find('.sk_caption').addClass('sk_'+params.indicatorsPosition);
		$(elt).find('.sk_'+params.indicatorsPosition).css('color', params.captionColor);
		$(elt).find('.sk_'+params.indicatorsPosition).css('background-color', params.captionBackground);
	    } else {
		$(elt).find('.sk_caption').css('display', 'none');
            }
	}

	function generateControls(elt, params) {
		if (params.arrows) {
		    var controlLeft = $('<span class="sk_control left"><</span>').addClass('sk_control_'+params.arrowsPosition);
		    var controlRight = $('<span class="sk_control right">></span>').addClass('sk_control_'+params.arrowsPosition);
		    $(elt).append($(controlLeft));
		    $(elt).append($(controlRight));

		    $(controlLeft).on('click', function(){
		        showPrevElement(elt, params);
		    });

		    $(controlRight).on('click', function(){
		        showNextElement(elt, params);
		    });
		}
	}

	function showElement(elt, params, id) {
		if (!$(elt).find('.sk_item_container').eq(id).hasClass('active')) {
		    $(elt).find('.sk_item_container.active').fadeOut(params.transitionSpeed, function(){$(elt).find('.sk_item_container').eq(id).fadeIn(params.transitionSpeed).addClass('active');$(this).removeClass('active');});
		}
		
	}

	function getIdActive(elt) {
	    var i = 0;
	    var ret = 0;
	    $(elt).find('.sk_item_container').each(function() {
	       if ($(this).hasClass('active')) {
	           ret = i;
	       }
	       i++; 
	    });

	    return ret;
	}

	function showPrevElement(elt, params) {
		var current =  getIdActive(elt);
		var toShow = current-1
		if (current == 0) {
		    toShow = countElement-1;
		}
		showElement(elt, params, toShow);
	}

	function showNextElement(elt, params) {
		var current =  getIdActive(elt);
		var toShow = current+1
		if (current == countElement-1) {
		    toShow = 0;
		}
		showElement(elt, params, toShow);
	}

        return this.each(function() {
	    countElement = $(this).find('.sk_item_container').length;

            if (params.indicators) {
                generateIndicator(this, params);
            }

	    generateCaption(this, params);

	    generateControls(this, params);
	    
        });
    };
})(jQuery);
